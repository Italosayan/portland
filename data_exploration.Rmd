---
title: "Initial Cuts of Portland Data"
date: "Compiled `r format(Sys.time(), '%B %d, %Y at %R')`"
output: 
  rmarkdown::html_document:
    toc: true
    number_sections: true
---

# Load data

(see source file for code)

```{r setup, include = FALSE, cache = FALSE}
# Adding Pau's code for KDE & K-function
knitr::read_chunk("kde.R")
#never display source code
knitr::opts_chunk$set(echo = FALSE)

#Michael Chirico's package of convenience functions;
#  devtools::install_github("MichaelChirico/funchir")
## Currently some sort of bug in the implementation
##   of this function when trying to detach packages, so skip
funchir::clean_slate(detach.packages = FALSE)

set.seed(922574) #from random.org

library(funchir)
#for reading .dbf files
library(foreign)
#for loading and manipulating geospatial objects
library(maptools)
library(rgeos)
library(spatstat)
library(GISTools)
#Development version 1.9.7 -- try
#  install.packages("data.table", type = "source",
#                   repos = "http://Rdatatable.github.io")
library(data.table)
#for printing HTML tables
library(xtable)

#Create an R Project in your local directory, and all of 
#  these relative paths will work out of the box
wds = c(data = "./data")

#Crime shapefiles' data
crimes = rbindlist(lapply(lapply(list.files(
  wds["data"], pattern = "^NIJ.*\\.dbf", full.names = TRUE),
  #as.is = TRUE is equivalent to stringsAsFactors = FALSE
  read.dbf, as.is = TRUE), setDT)
  #also, some missing data snuck in on one line
  )[!is.na(occ_date)]
setnames(crimes, tolower(names(crimes)))
crimes[ , occ_date := as.IDate(occ_date)]
crimes[ , occ_year := quick_year(occ_date)]
crimes[ , occ_wday := quick_wday(occ_date)]
crimes[ , occ_quarter := quarter(occ_date)]
crimes[ , occ_month := month(occ_date)]
#First-of-the-month containing occ_date
crimes[ , occ_mo_1st := occ_date - mday(occ_date) + 1L]
#Wednesday of the week containing occ_date
crimes[ , occ_wed := occ_date - occ_wday + 4L]

#From cross-referencing the project page,
#  spatialreference.org, and prj2epsg.org,
#  determined the following common CRS for
#  all project-associated shapefiles
prj = CRS("+init=epsg:2913")
crimes.map = 
  crimes[ , SpatialPointsDataFrame(
    coords = cbind(x_coordina, y_coordina),
    data = .SD[ , !(c("x", "y") %+% "_coordina"), with = FALSE],
    proj4string = prj)]
```

# Basic Descriptives

## Basics

Cross-tabs of the `category` and `call_group` columns of the main data. Burglary and motor vehicle theft make up only a small portion of total crimes. `OTHER` crimes are all over the place.

```{r plain, results = "asis"}
invisible(crimes[ , print(xtable(table(category, call_group)), type = "html")])
```

## Time Trends

### Overall Crime Time Series

There was a sort of spike in crime in 2015. Perhaps they had new coding protocols? Worth trying to understand better.

```{r time_series, echo = FALSE, results = "hide", warning = FALSE, message = FALSE}
dcast(crimes, occ_year ~ category
      )[ , {
        par(mar = c(5.1, 4.1, 4.1, 6.1))
        matplot(occ_year, sdx <- .SD[ , .(OTHER, `STREET CRIMES`)],
                type = "b", lty = 1L, axes = FALSE, col = "black",
                lwd = 3L, ylab = "", xlab = "", pch = c(0L, 1L),
                main = "Crime Counts by Year, Category")
        dput(range(sdx))
        axis(side = 2L, at = seq(nx.mlt(min(sdx), 5000),
                                 nx.mlt(max(sdx), 5000),
                                 length.out = 5))
        mtext("More-Frequent Crimes", side = 2L, line = 2.5)
        
        text(occ_year[1L], sdx[1L] + 10000,
             c("Other", "Street Crimes"), pos = 4L)
        
        par(new = TRUE)
        matplot(occ_year, sdx <- .SD[ , .(BURGLARY, `MOTOR VEHICLE THEFT`)],
                type = "b", lty = 1L, lwd = 3L, col = "red",
                xlab = "", ylab = "", axes = FALSE, pch = c(0L, 1L))
        axis(side = 4L, col = "red", col.axis = "red", las = 1L)
        mtext("Less-Frequent Crimes", side = 4L,
              line = 3.5, col = "red")
        
        text(occ_year[1L], sdx[1L] + 100, col = "red",
             labels = c("Burglary", "Vehicle Theft"), pos = 4L)
        
        axis(side = 1L)
        box()}]


dcast(crimes, occ_year ~ category
      )[ , {print(lapply(.SD, function(x) x/x[1L]))
        matplot(occ_year, sapply(.SD, function(x) x/x[1L]),
                xlab = "Year", main = "Relative Evolution of Crimes",
                ylab = "Frequency Relative to " %+% occ_year[1L],
                col = cols <- as.factor(names(.SD)),
                lty = 1L, type = "b", pch = 1L, las = 1L, lwd = 3L)
        abline(h = 1, col = "cornflowerblue")
        legend("bottomleft", legend = names(.SD), col = cols,
               lwd = 3L, pch = 1L)
        }, .SDcols = -1L]

dcast(crimes, occ_mo_1st ~ category
      )[ , {
        matplot(occ_mo_1st, sapply(.SD, function(x) x/x[1L]),
                xlab = "Date", xaxt = "n", las = 1L, lwd = 3L,
                main = "Relative Evolution of Crimes\n" %+% 
                  "(Monthly Cuts)", lty = 1L, type = "l", pch = 1L,
                ylab = "Frequency Relative to " %+% 
                  format(occ_mo_1st[1L], "%Y-%m"),
                col = cols <- as.factor(names(.SD)))
        axis(side = 1L, at = xs <- pretty(occ_mo_1st), 
             labels = as.character(xs))
        abline(h = 1, col = "cornflowerblue")
        legend("topleft", legend = names(.SD), col = cols,
               lwd = 3L, pch = 1L)
        }, .SDcols = -1L]

dcast(crimes, occ_wed ~ category
      )[ , {
        matplot(occ_wed, sapply(.SD, function(x) x/x[1L]),
                xlab = "Date", xaxt = "n", las = 1L, lwd = 3L,
                main = "Relative Evolution of Crimes\n" %+% 
                  "(Weekly Cuts)", lty = 1L, type = "l", pch = 1L,
                ylab = "Frequency Relative to " %+% occ_wed[1L],
                col = cols <- as.factor(names(.SD)))
        axis(side = 1L, at = xs <- pretty(occ_wed), 
             labels = as.character(xs))
        abline(h = 1, col = "cornflowerblue")
        legend("topleft", legend = names(.SD), col = cols,
               lwd = 3L, pch = 1L)
        }, .SDcols = -1L]
```

### Seasonality

Most crime occurs in the summer, but there doesn't appear to be much of a time trend for burglary or motor vehicle theft.

```{r seasonality, results = "hide", warning = FALSE, message = FALSE}
par(mar = c(5.1, 4.1, 4.1, 6.1))
crimes[ , .N, keyby = month(occ_date)
        ][ , plot(month, N, type = "l", lwd = 3L, xlab = "",
                  ylab = "Monthly Count", las = 1L,
                  main = "Count of All Crimes by Month/Week")]
par(new = TRUE)
crimes[ , .N, keyby = week(occ_date)
        ][-.N, plot(week, N, lwd = 3L, col = "red",
                  axes = FALSE, type = "l", xlab = "", ylab = "")]
axis(side = 1L, col = "red", col.axis = "red", line = 2L)
axis(side = 4L, col = "red", col.axis = "red", las = 1L)
mtext("Weekly Count", side = 4L, line = 3.5, col = "red")
#to reset margins
dev.off()

dcast(crimes, occ_month ~ category
      )[ , {
        matplot(occ_month, 
                sapply(.SD, function(x) x/x[1L]), col = 1L:4L,
                type = "l", lwd = 3L, xlab = "Month", 
                ylab = "", las = 1L, lty = 1L,
                main = "Relative Frequency of All Crimes\n" %+% 
                  "by Category, Month")
        legend("topright", legend = names(.SD),
               col = 1L:4L, lwd = 3L)
        abline(h = 1, col = "cornflowerblue")},
        .SDcols = -1L]
```

### Autocorrelation

```{r acf, results = "hide", message = FALSE}
dcast(crimes, occ_wed ~ category)[ , acf(.SD, ylab = ""), .SDcols = -1L]
```

### Partial Auto-Correlation

```{r pacf, results = "hide", message = FALSE}
dcast(crimes, occ_wed ~ category)[ , pacf(.SD, ylab = ""), .SDcols = -1L]
```


## Spatial Trends
```{r pau_setup, include = FALSE}
<<kdesetup>>
```

### Kernel Density Plots

```{r kdes, cache = TRUE, warning = FALSE}
<<kde>>
```

### K-Functions

```{r kfunctions, cache = TRUE, warning = FALSE}
<<kfunction>>
```

### Cross-L Functions

```{r crosslfunctions, cache = TRUE}
<<crossl>>
```

