---
title: "Initial Cuts of Portland Data"
date: "Compiled `r format(Sys.time(), '%B %d, %Y at %R')`"
output: 
  rmarkdown::html_document:
    toc: true
    number_sections: true
---

# Load data

(see source file for code)

```{r setup, include = FALSE}
#Michael Chirico's package of convenience functions;
#  devtools::install_github("MichaelChirico/funchir")
funchir::clean_slate()

set.seed(922574) #from random.org

library(funchir)
#for reading .dbf files
library(foreign)
#for loading and manipulating geospatial objects
library(maptools)
library(rgeos)
library(spatstat)
#Development version 1.9.7 -- try
#  install.packages("data.table", type = "source",
#                   repos = "http://Rdatatable.github.io")
library(data.table)
#for printing HTML tables
library(xtable)

#Create an R Project in your local directory, and all of 
#  these relative paths will work out of the box
wds = c(data = "./data")

#Crime shapefiles' data
crimes = rbindlist(lapply(lapply(list.files(
  wds["data"], pattern = "^NIJ.*\\.dbf", full.names = TRUE),
  #as.is = TRUE is equivalent to stringsAsFactors = FALSE
  read.dbf, as.is = TRUE), setDT)
  #also, some missing data snuck in on one line
  )[!is.na(occ_date)]
setnames(crimes, tolower(names(crimes)))
crimes[ , occ_date := as.IDate(occ_date)]
crimes[ , occ_year := quick_year(occ_date)]
crimes[ , occ_wday := quick_wday(occ_date)]
crimes[ , occ_quarter := quarter(occ_date)]
crimes[ , occ_month := month(occ_date)]

#From cross-referencing the project page,
#  spatialreference.org, and prj2epsg.org,
#  determined the following common CRS for
#  all project-associated shapefiles
prj = CRS("+init=epsg:2913")
crimes_map = 
  crimes[ , SpatialPointsDataFrame(
    coords = cbind(x_coordina, y_coordina),
    data = .SD[ , !(c("x", "y") %+% "_coordina"), with = FALSE],
    proj4string = prj)]
```

# Basic Descriptives

## Basics

Cross-tabs of the `category` and `call_group` columns of the main data. Burglary and motor vehicle theft make up only a small portion of total crimes. `OTHER` crimes are all over the place.

```{r plain, echo = FALSE, results = "asis"}
invisible(crimes[ , print(xtable(table(category, call_group)), type = "html")])
```

## Time Trends

### Overall Crime Time Series

There was a sort of spike in crime in 2015. Perhaps they had new coding protocols? Worth trying to understand better.

```{r time_series, echo = FALSE, results = "hide", warning = FALSE, message = FALSE}
dcast(crimes, occ_year ~ category
      )[ , {
        par(mar = c(5.1, 4.1, 4.1, 6.1))
        matplot(occ_year, sdx <- .SD[ , .(OTHER, `STREET CRIMES`)],
                type = "b", lty = 1L, axes = FALSE, col = "black",
                lwd = 3L, ylab = "", xlab = "", pch = c(0L, 1L),
                main = "Crime Counts by Year, Category")
        dput(range(sdx))
        axis(side = 2L, at = seq(nx.mlt(min(sdx), 5000),
                                 nx.mlt(max(sdx), 5000),
                                 length.out = 5))
        mtext("More-Frequent Crimes", side = 2L, line = 2.5)
        
        text(occ_year[1L], sdx[1L] + 10000,
             c("Other", "Street Crimes"), pos = 4L)
        
        par(new = TRUE)
        matplot(occ_year, sdx <- .SD[ , .(BURGLARY, `MOTOR VEHICLE THEFT`)],
                type = "b", lty = 1L, lwd = 3L, col = "red",
                xlab = "", ylab = "", axes = FALSE, pch = c(0L, 1L))
        axis(side = 4L, col = "red", col.axis = "red", las = 1L)
        mtext("Less-Frequent Crimes", side = 4L,
              line = 3.5, col = "red")
        
        text(occ_year[1L], sdx[1L] + 100, col = "red",
             labels = c("Burglary", "Vehicle Theft"), pos = 4L)
        
        axis(side = 1L)
        box()}]

dcast(crimes, occ_year ~ category
      )[ , {
        matplot(occ_year, sapply(.SD, function(x) x/x[1L]),
                xlab = "Year", main = "Relative Evolution of Crimes",
                ylab = "Frequency Relative to " %+% occ_year[1L],
                col = cols <- as.factor(names(.SD)),
                lty = 1L, type = "b", pch = 1L, las = 1L, lwd = 3L)
        abline(h = 1, col = "cornflowerblue")
        legend("bottomleft", legend = names(.SD), col = cols,
               lwd = 3L, pch = 1L)
        }, .SDcols = -1L]
```

### Seasonality

Most crime occurs in the summer, but there doesn't appear to be much of a time trend for burglary or motor vehicle theft.

```{r seasonality, echo = FALSE, results = "hide", warning = FALSE, message = FALSE}
crimes[ , .N, keyby = month(occ_date)
        ][ , plot(month, N, type = "l", lwd = 3L,
                  xlab = "Month", ylab = "", las = 1L,
                  main = "Count of All Crimes by Month")]

dcast(crimes, occ_month ~ category
      )[ , {
        matplot(occ_month, 
                dat <- log10(.SD[ , !"occ_month", with = FALSE]),
                type = "l", lwd = 3L, xlab = "Month", 
                ylab = "", las = 1L, lty = 1L,
                main = "(Log) Count of All Crimes\n" %+% 
                  "by Category, Month")
        labs = unlist(dat[occ_month == 12, ])
        text(12, labs+.1, names(labs), pos = 2L)}]
```

## Spatial Trends
